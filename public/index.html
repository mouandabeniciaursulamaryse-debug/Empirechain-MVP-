<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>EMPIRE CHAIN - NEXUS ALPHA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;600&display=swap');

        /* --- Global Reset & Body --- */
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #0d1117; /* Fond Deep Dark */
            font-family: 'Inter', sans-serif;
            color: white;
            overflow: hidden;
            position: relative;
        }

        /* --- Nexus Background (Soft Blue Pulse) --- */
        body::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            background: #2a6fdb;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            filter: blur(150px);
            opacity: 0.2;
            animation: backgroundPulse 10s infinite alternate ease-in-out;
            z-index: -1;
        }
        @keyframes backgroundPulse {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.2); }
        }

        /* --- Interface Container (Apple/Vibrancy Blur) --- */
        .interface-container {
            position: relative;
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.05); /* Très légère transparence */
            backdrop-filter: blur(30px) saturate(180%); /* Flou intense à la Apple */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            padding: 50px 30px;
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.6), 
                0 0 10px rgba(255, 255, 255, 0.1);
            text-align: center;
            animation: fadeIn 1s ease-out forwards;
            z-index: 1;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Title & Status --- */
        h1 {
            font-family: 'Cinzel', serif;
            font-size: 30px;
            letter-spacing: 5px;
            color: #38bdf8; /* Cyan Brillant */
            margin-bottom: 5px;
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.5);
            text-transform: uppercase;
        }
        .subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 40px;
        }

        /* --- USERNAME DISPLAY --- */
        #usernameDisplay {
            font-size: 18px;
            font-weight: 600;
            color: #ffd700; /* Or */
            margin-bottom: 30px;
            letter-spacing: 1px;
            min-height: 25px;
            /* Animation Scramble/Typewriter intégrée */
        }
        
        /* --- Central Core --- */
        .central-core {
            width: 120px;
            height: 120px;
            margin: 0 auto 40px;
            border-radius: 50%;
            border: 3px solid #38bdf8;
            background: radial-gradient(circle at 70% 30%, #4a00e0, #1e3a8a);
            box-shadow: 0 0 40px rgba(56, 189, 248, 0.8), inset 0 0 20px rgba(255, 255, 255, 0.1);
            animation: rotate3D 15s linear infinite; /* Animation de rotation 3D */
            transform-style: preserve-3d;
            perspective: 800px;
            position: relative;
        }
        @keyframes rotate3D {
            0% { transform: rotateY(0deg) rotateX(0deg); }
            50% { transform: rotateY(360deg) rotateX(15deg); }
            100% { transform: rotateY(720deg) rotateX(0deg); }
        }

        /* --- Action Button (Vibrancy Effect) --- */
        .btn-action {
            width: 100%;
            padding: 18px;
            border-radius: 15px;
            border: none;
            background: #38bdf8; /* Cyan Uni */
            color: #000;
            font-weight: 700;
            font-size: 15px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            box-shadow: 0 8px 30px rgba(56, 189, 248, 0.6);
        }
        .btn-action:hover {
            transform: translateY(-3px) scale(1.01);
            background: #60a5fa; /* Bleu plus doux */
            box-shadow: 0 12px 40px rgba(56, 189, 248, 0.8);
        }
        
        /* --- Status Message --- */
        #status-message {
            margin-top: 30px;
            font-size: 14px;
            color: #aebfd7;
            min-height: 20px;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

    </style>
</head>
<body>
    <div class="interface-container">
        <h1>NEXUS ALPHA</h1>
        <div class="subtitle">SYNCHRONISATION DES DONNÉES TITAN</div>

        <div id="usernameDisplay">INITIALISATION...</div>

        <div class="central-core" id="centralCore"></div>

        <button class="btn-action" id="saveBtn">COMMENCER LE JEU</button>
        
        <div id="status-message">EN ATTENTE D'AUTORISATION...</div>
    </div>

    <script>
        const statusMsg = document.getElementById('status-message');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const saveBtn = document.getElementById('saveBtn');
        let telegramUsername = 'UNKNOWN_USER'; // Par défaut

        // ---------------------------------------------
        // A. Fonction d'Animation de Texte "Scramble"
        // ---------------------------------------------
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+{}|:"<>?';
        function scrambleText(element, text, duration = 1000) {
            let iteration = 0;
            const interval = setInterval(() => {
                element.innerText = text.split("")
                    .map((char, index) => {
                        if (index < iteration) {
                            return text[index];
                        }
                        return characters[Math.floor(Math.random() * characters.length)];
                    })
                    .join("");
                
                if (iteration >= text.length) {
                    clearInterval(interval);
                }
                iteration += 1 / 3;
            }, 30);
        }

        // ---------------------------------------------
        // B. Connexion et Récupération du Nom d'Utilisateur
        // ---------------------------------------------
        function initializeTelegram() {
            try {
                // Initialisation de la mini-app
                if (window.Telegram && window.Telegram.WebApp) {
                     window.Telegram.WebApp.ready();

                    const user = window.Telegram.WebApp.initDataUnsafe.user;
                    if (user && user.username) {
                        telegramUsername = `@${user.username}`;
                    } else if (user && user.id) {
                         // Si pas de username, utiliser l'ID pour l'identification
                         telegramUsername = `ID TITAN ${user.id}`;
                    }
                }
            } catch (e) {
                // Pour le test hors de Telegram
                console.warn("SDK Telegram non disponible. Utilisation d'un ID de test.");
                telegramUsername = "@TEST_BENICIA_ALPHA";
            }
            
            // Afficher le nom d'utilisateur avec l'animation
            scrambleText(usernameDisplay, telegramUsername);
            
            statusMsg.innerText = "CLÉ TITAN OBTENUE. PRÊT À COMMENCER.";
            statusMsg.style.opacity = 1;

            saveBtn.disabled = false;
        }

        // ---------------------------------------------
        // C. Logique de Démarrage (Sauvegarde des données)
        // ---------------------------------------------
        document.getElementById('saveBtn').addEventListener('click', async () => {
            
            statusMsg.style.opacity = 0;
            saveBtn.innerText = "SYNCHRONISATION...";
            saveBtn.style.boxShadow = "0 0 40px rgba(56, 189, 248, 0.8) inset";

            try {
                // Envoi de l'ID utilisateur (réel ou de test) et des données initiales
                const response = await fetch('/api/save_wealth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: telegramUsername, // L'ID utilisateur unique
                        wealth: 1000, 
                        name: "Fief du " + telegramUsername
                    })
                });

                if (response.ok) {
                    statusMsg.innerText = "CONNEXION ÉTABLIE. ENTRÉE DANS L'EMPIRE...";
                    statusMsg.style.color = "#32cd32"; 
                    statusMsg.style.opacity = 1;
                    
                    // Optionnel: Fermer la mini-app après succès (pour retour au bot)
                    // window.Telegram.WebApp.close(); 

                } else {
                    throw new Error("Erreur Serveur: " + response.statusText);
                }
            } catch (error) {
                statusMsg.innerText = "ERREUR FATALE. PROTOCOLE ÉCHOUÉ.";
                statusMsg.style.color = "#ff4d4d";
                statusMsg.style.opacity = 1;
            } finally {
                saveBtn.innerText = "COMMENCER LE JEU";
                saveBtn.style.boxShadow = "none"; 
            }
        });
        
        // Démarrer l'initialisation dès le chargement de la page
        initializeTelegram();

    </script>
</body>
</html>
